#include <iostream>
#include <vector>
#include <set>
using namespace std;

class Node {
public:
    char val;
    int data;
    Node* left;
    Node* right;
    vector<int> firstpos;
    vector<int> lastpos;
    bool nullable;
    
    Node(vector<int> firstpos, vector<int> lastpos, char val, int data) {
        this->firstpos = firstpos;
        this->lastpos = lastpos;
        this->left = nullptr;
        this->right = nullptr;
        this->val = val;
        this->data = data;
        this->nullable = false;
    }
    
    Node(vector<int> firstpos, vector<int> lastpos, char val, int data, Node* left, Node* right) {
        this->firstpos = firstpos;
        this->lastpos = lastpos;
        this->left = left;
        this->right = right;
        this->val = val;
        this->data = data;
        this->nullable = false;
    }
};

void printInorder(Node* node) {
    if (node == nullptr)
        return;
    
    printInorder(node->left);
    printInorder(node->right);
    
    if(node->data == 0) {
        if(node->val == '/') {  /
            set<int> temp(node->left->firstpos.begin(), node->left->firstpos.end());
            temp.insert(node->right->firstpos.begin(), node->right->firstpos.end());
            node->firstpos.assign(temp.begin(), temp.end());
            
            temp.clear();
            temp.insert(node->left->lastpos.begin(), node->left->lastpos.end());
            temp.insert(node->right->lastpos.begin(), node->right->lastpos.end());
            node->lastpos.assign(temp.begin(), temp.end());
            
            node->nullable = node->left->nullable || node->right->nullable;
            
        } else if(node->val == '*') { 
            node->firstpos = node->left->firstpos;
            node->lastpos = node->left->lastpos;
            node->nullable = true;
            
        } else if(node->val == '.') {  
            if(node->left->nullable) {
                set<int> temp(node->left->firstpos.begin(), node->left->firstpos.end());
                temp.insert(node->right->firstpos.begin(), node->right->firstpos.end());
                node->firstpos.assign(temp.begin(), temp.end());
            } else {
                node->firstpos = node->left->firstpos;
            }
            
            if(node->right->nullable) {
                set<int> temp(node->left->lastpos.begin(), node->left->lastpos.end());
                temp.insert(node->right->lastpos.begin(), node->right->lastpos.end());
                node->lastpos.assign(temp.begin(), temp.end());
            } else {
                node->lastpos = node->right->lastpos;
            }
            
            node->nullable = node->left->nullable && node->right->nullable;
        }
    }
    
    cout << "\nNode: " << node->val;
    cout << "\nFirstpos: ";
    for(int i: node->firstpos) cout << i << " ";
    cout << "\nLastpos: ";
    for(int i: node->lastpos) cout << i << " ";
}

int main() {
    // Build tree for: ((a|b)*a b b)#
    Node* a1 = new Node({1}, {1}, 'a', 1);
    Node* b1 = new Node({2}, {2}, 'b', 2);
    Node* slash1 = new Node({}, {}, '/', 0, a1, b1);
    Node* star1 = new Node({}, {}, '*', 0, slash1, nullptr);
    
    Node* a2 = new Node({3}, {3}, 'a', 3);
    Node* cat1 = new Node({}, {}, '.', 0, star1, a2);
    
    Node* b2 = new Node({4}, {4}, 'b', 4);
    Node* cat2 = new Node({}, {}, '.', 0, cat1, b2);
    
    Node* b3 = new Node({5}, {5}, 'b', 5);
    Node* cat3 = new Node({}, {}, '.', 0, cat2, b3);
    
    Node* hash = new Node({6}, {6}, '#', 6);
    Node* cat4 = new Node({}, {}, '.', 0, cat3, hash);
    
    cout << "Inorder traversal: ";
    printInorder(cat4);
    cout << endl;
    
    cout << "\nRoot firstpos: ";
    for (int i : cat4->firstpos) cout << i << " ";
    cout << "\nRoot lastpos: ";
    for (int i : cat4->lastpos) cout << i << " ";
    cout << "\n";
    
    return 0;
}
